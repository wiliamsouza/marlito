#!/bin/bash -e

confd=/etc/nginx/conf.d
log=/var/log/nginx
html=/usr/share/nginx/html
available=/etc/nginx/sites-available
enabled=/etc/nginx/sites-enabled
etcd=${COREOS_IP}:4001

until /usr/local/bin/confd -onetime -node $etcd -config-file /etc/confid/confd.toml 2>/dev/null; do
    sleep 1
done

/usr/local/bin/confd -node $etcd -config-file /etc/confd/confd.toml &

# Enable available sites
for site in $(ls $available); do
    if [ ! -e $enabled/$site ]; then
        ln -s $available/$site $enabled/$site
    fi
done

exec supervisord
